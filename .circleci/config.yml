version: 2.1

workflows:
  version: 2
  default:
    jobs:
      - macos-job:
          name: SPM Test
jobs:
  macos-job:
    macos:
      xcode: "12.3.0"
    environment:
      HOMEBREW_NO_AUTO_UPDATE: 1
    steps:
      - checkout
      - run:
          name: SPM SSH fix
          command: |
            rm ~/.ssh/id_rsa
            for ip in $(dig @8.8.8.8 github.com +short); do ssh-keyscan github.com,$ip; ssh-keyscan $ip; done 2>/dev/null >> ~/.ssh/known_hosts || true
      - run:
          name: Build SPMTest example 
          command: |
            pushd Tests/SPMIntegration
            brew install mint
            mint install yonaskolb/xcodegen
            xcodegen
            xcodebuild -project SPMTest.xcodeproj -scheme SPMTest clean build -destination 'platform=iOS Simulator,name=iPhone 11,OS=latest'
